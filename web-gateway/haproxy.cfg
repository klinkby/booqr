global
    log stdout local0 info
    # Memory optimization settings
    tune.bufsize 16384
    tune.maxrewrite 1024
    tune.http.maxhdr 101
    maxconn 1000
    # Security settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2

defaults
    mode    http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option redispatch
    option log-health-checks
    no option httpclose
    option forwardfor
    option originalto

cache web-cache
    total-max-size 10
    max-object-size 262144

frontend http-8080
    bind *:8080
    maxconn 100
    # Security ACLs
    acl is_health path /health
    acl suspicious_ua hdr_sub(User-Agent) -i bot crawler spider scan
    acl large_request hdr_val(content-length) gt 10485760
    # Rate limiting
    stick-table type ip size 10k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 10 }
    # Block suspicious requests
    http-request deny if suspicious_ua
    http-request deny if large_request
    http-request return status 200 content-type "text/plain" lf-string "Healthy" if is_health
    redirect scheme https code 301 unless is_health

frontend https-8443
    log     global
    option  httplog
    option dontlognull
    bind *:8443 ssl crt /etc/letsencrypt/live/beta.booqr.com/haproxy.pem alpn h2,http/1.1 ssl-min-ver TLSv1.2
    maxconn 1000
    # Security ACLs
    acl suspicious_ua hdr_sub(User-Agent) -i bot crawler spider scan
    acl large_request hdr_val(content-length) gt 10485760
    acl blocked_methods method TRACE CONNECT
    acl valid_methods method GET POST PUT DELETE PATCH HEAD OPTIONS
    # Rate limiting
    stick-table type ip size 10k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 50 }
    # Block suspicious requests
    http-request deny if blocked_methods
    http-request deny if !valid_methods
    http-request deny if suspicious_ua
    http-request deny if large_request
    default_backend api 

backend api
    http-request cache-use web-cache
    http-response cache-store web-cache
    server api1 api1:8080 check maxconn 100
